<html>
<head>
<title>Reader Test</title>
<script src = "qcode\build\qcode-decoder.min.js"></script>
<style>
@media screen and (max-width <= 750px) {
	video#v { 
		position: fixed;
		right: 0;
		bottom: 0;
		min-width: 100%;
		min-height: 100%;
		width: auto;
		height: auto;
		z-index: -100;
		background-size: cover; 
	}
}
</style>
<script>
var v=null;
var labels = [];
var ids = [];
var vidhtml = '<video id="v" autoplay></video>';
var fliphtml = '<button id = "flipbtn">Flip Camera</button>';
var userStream;

function load()
{
	navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia);
        if(navigator.getUserMedia) {
		navigator.getUserMedia({audio: false, video: true}, function(st) {
			userStream = st;
			var videoTracks = userStream.getVideoTracks();
			if(videoTracks.length > 0) {
				videoTracks[0].stop();
				userStream.removeTrack(videoTracks[0]);
			}
		}, function(err) {
			console.log(err);
		});
	}
	else {
		console.log('getUserMedia not supported');
	}
}
</script>
<script>
function setwebcam()
{
	//document.getElementById('scannerbtn').style.display = 'none';
	ids = [];
	labels = [];
	var options = null;
	
	if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
	    try {
			navigator.mediaDevices.enumerateDevices().then(function(devices) {
				devices.forEach(function(device) {
					if(device.kind === 'videoinput') {
						ids.push(device.deviceId);
						labels.push(device.label);
					}
				});

				var tempId = ids.shift();
				ids.push(tempId);
				var tempLabel = labels.shift();
				labels.push(tempLabel);

				options = {deviceId: tempId};

				if(ids.length > 1) {
					//create flip button
					document.getElementById("flipp").innerHTML = fliphtml;
    					document.getElementById("flipbtn").addEventListener('click', flipCamera);
				}
				
				setwebcam2(options);
			});
		}
		catch(e) {
			console.log(e);
		}
	}
	else {
		console.log("no navigator.mediaDevices.enumerateDevices" );
	}
}

function setwebcam2(options)
{
    document.getElementById("result").innerHTML="- scanning -";
    document.getElementById("outdiv").innerHTML = vidhtml;
	
    v = document.getElementById("v");
	
    navigator.getUserMedia({video: options, audio: false}, success, error);
}

function success(stream) {
    userStream = stream;
    //if ("srcObject" in v) {
    //	v.srcObject = stream;
    //}
    //else {
    v.src = window.URL.createObjectURL(stream);
    //}
    
    startDecode();
}
		
function error(err)
{
    alert(err);
    return;
}

function startDecode() {
    'use strict';
    
    QCodeDecoder().decodeFromVideo(v, function(er,res) {
		if(res != undefined) {
			alert(res);
			var scanElem = document.getElementById('scannerbtn');
			scanElem.parentNode.removeElement(scanElem);
		}
    });
}

function flipCamera()
{
	var videoTracks = userStream.getVideoTracks();
	if(videoTracks.length > 0) {
		videoTracks[0].stop();
		userStream.removeTrack(videoTracks[0]);
	}
	
	var tempId = ids.shift();
	ids.push(tempId);
	var tempLabel = labels.shift();
	labels.push(tempLabel);
	
	var options = {deviceId: tempId};
	
	setwebcam2(options);
}
</script>
</head>
<body onload = "load()">
<button id = 'scannerbtn' onclick = 'setwebcam()'>Capture</button>
<div id = "flipp"></div>
<div id="outdiv"></div>
<div id = "result"></div>
</body>
</html>
