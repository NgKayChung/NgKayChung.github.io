<html>
<head>
<title>Reader Test</title>
<script src = "qcode\build\qcode-decoder.min.js"></script>
<!--style>
@media screen and (max-width: 1000px) {
	#v { 
		position: fixed;
		right: 0;
		bottom: 0;
		min-width: 100%;
		min-height: 100%;
		width: auto;
		height: auto;
		z-index: -100;
		background-size: cover; 
	}
}
</style-->
<script type = "text/javascript">
var v=null;
var labels = [];
var ids = [];
var vidhtml = '<video id="v" autoplay></video>';
var fliphtml = '<button id = "flipbtn">Flip Camera</button>';
var formhtml = '<form method = "get">' +
		'Full Name : <input type = "text" length = "50" id = "fullname" name = "fullname" required/><br/>' +
    		'Identity Card Number : <input type = "text" length = "12" id = "icnumber" name = "icnumber" required/><br/>' +
		'Email Address : <input type = "email" id = "emailAddress" name = "emailAddress" required/><br/>' +
    		'Phone Number : <input type = "text" id = "phoneNumber" name = "phoneNumber" required/><br/>' +
    		'<input type = "submit" name = "submit"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type = "reset" name = "reset"/>' +
    		'</form>';

function load()
{
	navigator.mediaDevices = navigator.mediaDevices || ((navigator.mozGetUserMedia || navigator.webkitGetUserMedia) ? {
		getUserMedia: function(c) {
	 		return new Promise(function(y, n) {
				(navigator.mozGetUserMedia || navigator.webkitGetUserMedia).call(navigator, c, y, n);
			});
		}
	} : null);
		
	if(!navigator.mediaDevices) {
		
		alert('No media device detected, please proceed to upload image to complete the registration');
		return false;
	}
	
	if(!navigator.mediaDevices.enumerateDevices) {
		alert("Media devices are not enumerable, please proceed to upload image to complete the registration");
		return false;
	}
	
	enumerateDevices();
	
	if(ids.length <= 0) {
		alert("No video input device detected, please proceed to upload image to complete the registration");
		return false;
	}
	
	navigator.mediaDevices.getUserMedia({audio: false, video: {deviceid: ids[0]}}).then(successRes).catch(error);
	return true;
}

function enumerateDevices()
{
	navigator.mediaDevices.enumerateDevices().then(function(devices) {
		devices.forEach(function(device) {
			if(device.kind === 'videoinput') {
				ids.push(device.deviceId);
				labels.push(device.label);
			}
		}
	});
}

function successRes(st)
{
	window.stream = st;
	stopMedia();
}

function error(err)
{
    console.log(err);
    return;
}

function stopMedia()
{
	var videoTracks = window.stream.getVideoTracks();
	if(videoTracks.length > 0) {
		videoTracks[0].stop();
		window.stream.removeTrack(videoTracks[0]);
	}
}
</script>
<script type = "text/javascript">
function setwebcam()
{
	ids = [];
	labels = [];
	
	if(!load()) {
		//change to upload image
		return;
	}
	
	ids = [];
	labels = [];
	
	document.getElementById('scannerbtn').style.display = 'none';
	
	var options = null;
	
	enumerateDevices();
	
	var tempId = ids.shift();
	ids.push(tempId);
				
	if(ids.length > 1) {
		//create flip button
		document.getElementById("flipp").innerHTML = fliphtml;
    	document.getElementById("flipbtn").addEventListener('click', flipCamera);
					
		/*var tempLabel = "";
					
		for(var i = 1;i <= ids.length;i++) {
			tempLabel = labels.shift();
			labels.push(tempLabel);
						
			//if device is a back camera
			//scan with this camera ID
			if(tempLabel.indexOf('back') != -1) {
				break;
			}
			else {
				tempId = ids.shift();
				ids.push(tempId);
			}
		}*/
	}
				
	options = {deviceId: tempId};
								
	setwebcam2(options);
}

function setwebcam2(options)
{
	navigator.mediaDevices.getUserMedia({audio: false, video: options}).then(success).catch(error);
}

function success(stream) {
	document.getElementById("outdiv").innerHTML = vidhtml;
    v = document.getElementById("v");
	
    window.stream = stream;
	
    v.srcObject = stream;
	
	document.getElementById("result").innerHTML="- scanning -";
	
    startDecode();
}

var done = false;

function startDecode() {
    'use strict';
    
    var qr = QCodeDecoder();

    qr.decodeFromVideo(v, function(er,res) {
		if(er) {
			console.log(er);
		}

		if(res && !done) {
			done = true;
			alert(res);
			//qr.stop();
			v.srcObject = null;
			stopMedia();
			var scanElem = document.getElementById('scannerbtn');
			scanElem.remove();
			var flipElem = document.getElementById('flipp');
			flipElem.remove();
			var resElem = document.getElementById('result');
			resElem.innerHTML = "Scanned successfully!";
			resElem.style.color = "green";
			document.getElementById("outdiv").innerHTML = formhtml;
		}
    }, true);
}

function flipCamera()
{
	v.srcObject = null;
	stopMedia();
	
	var tempId = ids.shift();
	ids.push(tempId);
	
	var options = {deviceId: tempId};
	
	setwebcam2(options);
}
</script>
</head>
<body>
<button id = 'scannerbtn' onclick = 'setwebcam()'>Capture</button>
<div id = "flipp"></div>
<div id="outdiv"></div>
<div id = "result"></div>
</body>
</html>
